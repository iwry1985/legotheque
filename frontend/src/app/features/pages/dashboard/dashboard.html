<div class="dashboard">
  <p-button
    label="Profil"
    size="large"
    icon="pi pi-chevron-left"
    class="previous"
    severity="secondary"
    routerLink="/profil"
  />
  <div class="minifig">
    <img src="minifigs/detective.png" alt="minifig-sherlock" />
  </div>
  <header class="dashboard__header container">
    <div class="titles">
      <h1>Ma collection LEGO®</h1>
      <p class="subtitle">
        Analyse des achats, de la valeur et de la progression
      </p>
    </div>

    <div class="filters">
      <button
        class="btn btn--ghost"
        [ngClass]="{'active': rangeFilter === 'all'}"
        (click)="selectRange('all')"
      >
        Tous les temps
      </button>
      <button
        class="btn btn--ghost"
        [ngClass]="{'active': rangeFilter === 'year'}"
        (click)="selectRange('year')"
      >
        Cette année
      </button>
      <button
        class="btn btn--ghost"
        [ngClass]="{'active': rangeFilter === 'month'}"
        (click)="selectRange('month')"
      >
        Ce mois
      </button>
    </div>
  </header>

  @if(dashboard()?.summary) {
  <main class="dashboard__grid container">
    <!-- Activité & Évolution -->
    <section class="card card--wide">
      <div class="card__head">
        <h2>Achats & Dépenses dans le temps</h2>
        <span class="hint">/mois ou /année</span>
      </div>
      <div class="card__body">
        <canvas #chart id="purchasesOverTime"></canvas>
      </div>
    </section>

    <!-- Stats Achats -->
    <aside class="card card--stats">
      <ul class="kpis">
        <li>
          <span class="kpis__label">Achats totaux</span>
          <span class="kpis__value">
            {{ dashboard()?.summary?.totalSets || '—' }}
          </span>
        </li>
        <li>
          <span class="kpis__label">Moyenne/mois</span>
          <span class="kpis__value">
            {{ ((dashboard()?.summary?.totalSets &&
            dashboard()?.summary?.totalSets / 12) | number : '1.0-1') || '—' }}
          </span>
        </li>
        <li>
          <span class="kpis__label">Budget total (€)</span>
          <span class="kpis__value">
            {{ (dashboard()?.summary?.totalValue | number : '1.2-2') || '—' }}
          </span>
        </li>
      </ul>
    </aside>

    <!-- Répartition -->
    <div class="row">
      <section class="card half">
        <div class="card__head"><h2>Répartition par thème</h2></div>
        <div class="card__body chart-center">
          <canvas #chart id="themesPie"></canvas>
        </div>
      </section>

      <section class="card half">
        <div class="card__head"><h2>Sets avec minifigs</h2></div>
        <div class="card__body chart-center">
          <canvas #chart id="minifigsPie"></canvas>
        </div>
      </section>
    </div>

    <!-- Valeur & Taille -->
    <div class="row">
      <section class="card half">
        <div class="card__head"><h2>Histogramme valeur estimée</h2></div>
        <div class="card__body">
          <canvas #chart id="estimatedValueHistogram"></canvas>
        </div>
      </section>

      <section class="card half">
        <div class="card__head">
          <h2>Histogramme par tranches de pièces</h2>
        </div>
        <div class="card__body">
          <canvas #chart id="piecesBucketsHistogram"></canvas>
        </div>
      </section>
    </div>

    <!-- Progression -->
    <section class="card card--wide">
      <div class="card__head"><h2>Progression des sets construits</h2></div>
      <div class="card__body">
        <canvas #chart id="builtCumulative"></canvas>
      </div>
    </section>

    <!-- Stats Construction -->
    <aside class="card card--stats">
      <ul class="kpis">
        <li>
          <span class="kpis__label">Taux de construction</span>
          <span class="kpis__value">
            {{ dashboard()?.summary?.builtRatio }} %
          </span>
        </li>
        <li>
          <span class="kpis__label">Sets reçus en cadeau</span>
          <span class="kpis__value">
            {{ dashboard()?.summary?.totalGifts }} ({{
            dashboard()?.summary?.giftsRatio }} %)
          </span>
        </li>
        <!-- <li>
          <span class="kpis__label">Temps moyen avant construction</span>
          <span class="kpis__value">—</span>
        </li> -->
      </ul>
    </aside>

    <!-- Tops -->
    <div class="row">
      <section class="card half">
        <div class="card__head"><h2>Top 5 thèmes construits</h2></div>
        <div class="card__body">
          <canvas #chart id="topThemesBuilt"></canvas>
        </div>
      </section>

      <section class="card half">
        <div class="card__head"><h2>Top 5 sets les plus chers</h2></div>
        <div class="card__body">
          <canvas #chart id="topExpensiveSets"></canvas>
        </div>
      </section>
    </div>
  </main>
  } @else {
  <div class="no-content">
    <img src="minifigs/brick.png" alt="minifig" />
    <p>Aucune donnée à afficher</p>
    <em>Get your bricks on!</em>
  </div>
  }
</div>
